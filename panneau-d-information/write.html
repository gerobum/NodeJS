<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Bonjour Maman</title>
        <style>
            #zone_msg {
                color: white;
                background-color: #5890AD;
                padding: 2px;
            }
            #zone_msg {
                color: white;
                background-color: #ffc520;
                padding: 2px;
            }
            .cliquable {
                cursor: pointer;
                color: #b81900
            }
            .titre {
                background-color: #008; 
                color: antiquewhite; 
                padding: 0 0 0 5px; 
                margin: 0 0 0 0;
                line-height:1em;
                border-style: hidden;
                font-family: "Bradley Hand", cursive, fantasy, Georgia, "DejaVu Serif", Norasi, serif;
            }
            .liste {
                padding: 5px; 
                margin: 0 0 0 0;
                line-height:1em;
                border-style: hidden;
                font-family: Georgia, "DejaVu Serif", Norasi, serif;
            }
            .pair {
                background-color: #BAFFA8;
                color: #000;
            }
            .impair {
                background-color: #FFFFD0;
                color: #000;
            }
            .hsep {
                border-style: inset;
                padding: 0.5%;
            }
            textarea{
                width:95%;
            }
        </style>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="/resources/demos/style.css">
        <link rel="stylesheet" href="include/ui-1.10.0/ui-lightness/jquery-ui-1.10.0.custom.min.css" type="text/css" />
        <link rel="stylesheet" href="jquery.ui.timepicker.css?v=0.3.3" type="text/css" />

    </head>

    <body>
        <h1 class="titre">Bonjour Maman</h1>        
        <h2 class="titre">Nous sommes le <span id="div_date"></span></h2>
        <h2 class="titre" style="padding-bottom: 5px;">Il est <span id="div_horloge"></span></h2>
        <div class="titre" id="zone_msg">
        </div>


        <div id="msgarea"></div>
        <p>
            <img src="images/image0.png" alt="image0" />
            <img src="images/image1.png" alt="image1" />
            <img src="images/image2.png" alt="image2" />
        </p>

        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="js/datepicker-config.js"></script>

        <script>
            /*
             * Action à associer à un chechbox.
             * Rend "enabled" ou "disabled" tous les éléments qui ont
             * une classe en commun avec le checkbox (sauf le checkbox lui-même)
             * selon qu'il soit coché ou non.
             */
            function toggle(event) {
                var cb = event.target;
                var ips = cb.classList;
                for (var e of document.getElementsByClassName(ips)) {
                    e.disabled = !cb.checked;
                }
                cb.disabled = false;
            }
            /*
             * Action à associer à un chechbox.
             * Rend "enabled" ou "disabled" tous les éléments qui ont
             * une classe en commun avec le checkbox (sauf le checkbox lui-même)
             * selon qu'il soit coché ou non.
             */
            function send(event) {
                var message = document.getElementById("newtodo").value.trim();
                var liste = [];
                for (var e of document.getElementsByClassName("message")) {
                    liste.push(e.value);
                }

                if (message !== "") {
                    //var date = document.getElementById("iddp").value;
                    var date = $("#iddp").datepicker('getDate');
                    console.log(date);
                    if (date !== null) {
                        date.setHours(23);
                        date.setMinutes(59);
                    }
                    var hrd = new Horaire(
                            (document.getElementById("hdebut").value),
                            (document.getElementById("mdebut").value));
                    var hro = new Horaire(
                            (document.getElementById("hordre").value),
                            (document.getElementById("mordre").value));

                    var hrf = new Horaire(
                            (document.getElementById("hfin").value),
                            (document.getElementById("mfin").value));

                    console.log(hrf.toString());
                    var cm = new ChronoMessage(date, document.getElementById("idjour").value, hrd, hro, hrf, message);

                    liste.push(cm);


                }

                liste = datify(liste);

                socket.emit('change_list', liste); // Transmet la liste au serveur
                init();
                return false;
            }
            function one_msg(i, todo) {
                var classe;
                if (i % 2 === 0) {
                    classe = "pair";
                } else {
                    classe = "impair";
                }
                //return "<p class=\"liste " + classe + "\"><span class=\"cliquable\" onclick=\"up(" + i + ")\"> (↑) </span><span class=\"cliquable\" onclick=\"down(" + i + ")\"> (↓) </span><span class=\"cliquable\" onclick=\"sup(" + i + ")\"> (✘) </span><textarea class=\"message\" cols=\"120\" rows=\"1\">" + todo + "</textarea></p>";            
                return "<p num=\"" + i + "\" class=\"liste " + classe + "\"><button class=\"cliquable\" onclick=\"sup(" + i + ")\"> ✘ </button><textarea class=\"message\" cols=\"150\" rows=\"3\">" + todo + "</textarea></p>";
            }
            function mutex(event) {
                var cbjour = document.getElementById("idcbjour");
                var cbdate = document.getElementById("iddate");
                var jourchoice = document.getElementById("idjour");
                var datechoice = $("#iddp");

                if (cbjour === event.target) {
                    if (cbjour.checked) {
                        cbdate.checked = false;
                        datechoice.value = null;
                        datechoice.disabled = true;
                    }
                } else if (cbdate === event.target) {
                    if (cbjour.checked) {
                        cbjour.checked = false;
                        jourchoice.selectedIndex = 0;
                        jourchoice.disabled = true;
                    }
                    if (cbdate.checked) {
                        let date = new Date();
                        datechoice.value = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
                    } else {
                        datechoice.value = null;
                    }
                }
            }
        </script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="./js/ChronoMessage.js"></script>
        <!-- 
        Permet de paramétrer la variable localhost
        Le fichier "./js/hostname.js" est dans .gitignore.
        Il définit localement la variable hostname
        -->
        <script src="./js/hostname.js"></script>
        <script>
            function format(i) {
                if (i < 10) {
                    return "0" + i;
                } else {
                    return i;
                }
            }

            function createJour(name, cname, suffixe = "",  jour = "") {
                var span = document.createElement("span");
                span.setAttribute("class", "hsep");
                span.appendChild(document.createTextNode(name + " : "));

                var elt = document.createElement("input");
                elt.setAttribute("id", "idcb" + cname + suffixe);
                elt.setAttribute("class", cname + suffixe);
                elt.setAttribute("type", "checkbox");
                span.appendChild(elt);

                elt = document.createElement("select");
                elt.setAttribute("disabled", true);
                elt.setAttribute("id", "id" + cname + suffixe);
                elt.setAttribute("class", cname + suffixe);
                elt.setAttribute("name", "nom");
                
                jours = ["Tous les jours", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];

                for (let j of jours) {
                    let opt = document.createElement("option");
                    opt.appendChild(document.createTextNode(j));
                    elt.appendChild(opt);
                }
                
                try {
                    elt.selectedIndex = jours.indexOf(jour);
                } catch (e) {
                    
                }

                span.appendChild(elt);

                return span;
            }
            /*
             <span class="hsep">Début : <input id="iddebut" type="checkbox" class="debut"/>
             <select disabled class="debut" id="hdebut" name="nom">
             <option>00
             <option>23              
             </select>: 
             <select disabled class="debut" id="mdebut" name="nom" size="1">
             <option>00
             <option>55             
             </select>
             </span>
             */
            function createHoraire(name, cname, suffixe = "", horaire = null) {
                var span = document.createElement("span");
                span.setAttribute("class", "hsep");
                span.appendChild(document.createTextNode(name + " : "));

                var elt = document.createElement("input");
                elt.setAttribute("id", "id" + cname + suffixe);
                elt.setAttribute("class", cname + suffixe);
                elt.setAttribute("type", "checkbox");
                span.appendChild(elt);

                elt = document.createElement("select");
                elt.setAttribute("disabled", true);
                elt.setAttribute("id", "h" + cname + suffixe);
                elt.setAttribute("class", cname + suffixe);
                elt.setAttribute("name", "nom");

                for (let i = 0; i < 24; i++) {
                    let opt = document.createElement("option");
                    opt.appendChild(document.createTextNode(format(i)));
                    elt.appendChild(opt);
                }
                if (horaire !== null) {
                    elt.selectedIndex = horaire.h;
                }

                span.appendChild(elt);

                span.appendChild(document.createTextNode(" : "));

                elt = document.createElement("select");
                elt.setAttribute("disabled", true);
                elt.setAttribute("id", "m" + cname + suffixe);
                elt.setAttribute("class", cname + suffixe);
                elt.setAttribute("name", "nom");
                elt.setAttribute("size", "1");

                for (let i = 0; i < 60; i += 5) {
                    let opt = document.createElement("option");
                    opt.appendChild(document.createTextNode(format(i)));
                    elt.appendChild(opt);
                }
                if (horaire !== null) {
                    elt.selectedIndex = horaire.m %5;
                }

                span.appendChild(elt);

                return span;
            }
            /* <span class="hsep">Date: <input id="iddate" class="date" type="checkbox" />
             * <input disabled id="datepicker" type="text" class="date" autofocus/></span>
             */
            function createDate(suffixid = "", date = null) {
                var span = document.createElement("span");
                span.setAttribute("class", "hsep");
                span.appendChild(document.createTextNode("Date : "));

                var elt = document.createElement("input");
                elt.setAttribute("id", "iddate" + suffixid);
                elt.setAttribute("class", "date");
                elt.setAttribute("type", "checkbox");
                span.appendChild(elt);

                elt = document.createElement("input");
                elt.setAttribute("id", "iddp" + suffixid);
                $(elt).datepicker({setDate: date});

                elt.setAttribute("class", "date");
                elt.setAttribute("class", "date");
                elt.setAttribute("type", "text");
                if (date === null)
                    elt.value = "";
                else
                    elt.value = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
                elt.setAttribute("autofocus", true);
                span.appendChild(elt);

                return span;
            }
            /*
             *  <textarea cols="80" rows="10" placeholder="Un message" name="newtodo" id="newtodo" ></textarea>        
             */
            function createTextArea(id) {
                var elt = document.createElement("textarea");
                elt.setAttribute("id", id);
                elt.setAttribute("name", id);
                elt.setAttribute("cols", 80);
                elt.setAttribute("rows", 10);
                elt.setAttribute("placeholder", "Un message");

                return elt;
            }
            /*
             * <button id="sendbutton">Envoyer le message</button>
             */
            function createSendButton(id) {
                var elt = document.createElement("button");
                elt.setAttribute("id", id);
                elt.appendChild(document.createTextNode("Envoyer le message"));

                return elt;
            }
            function create() {
                var n = document.getElementById("msgarea");
                var p = document.createElement("p");
                p.appendChild(createDate());
                p.appendChild(createHoraire("Début", "debut"));
                p.appendChild(createJour("Jour", "jour"));
                p.appendChild(createHoraire("Ordre", "ordre"));
                p.appendChild(createHoraire("Expiration", "fin"));
                p.appendChild(createTextArea("newtodo"));
                p.appendChild(createSendButton("sendbutton"));

                n.appendChild(p);
            }


            function createOneMsg(i, cm) {
                var classe;
                if (i % 2 === 0) {
                    classe = "pair";
                } else {
                    classe = "impair";
                }
                var p = document.createElement("p");
                p.setAttribute("class", "liste " + classe);
                p.setAttribute("num", i);
                var elt;
                elt = document.createElement("button");
                elt.setAttribute("class", "cliquable");
                elt.appendChild(document.createTextNode("X"));
                elt.addEventListener("click", sup, false);

                p.appendChild(elt);

                p.appendChild(createDate(i, cm.date));
                p.appendChild(createHoraire("Début", "debut", i, cm.debut));
                p.appendChild(createJour("Jour", "jour", i, cm.jour));
                p.appendChild(createHoraire("Ordre", "ordre", i, cm.ordre));
                p.appendChild(createHoraire("Expiration", "fin", i, cm.fin));

                elt = document.createElement("textarea");
                elt.setAttribute("class", "message");
                elt.appendChild(document.createTextNode(cm.toString()));

                p.appendChild(elt);

                return p;

                //return "<p class=\"liste " + classe + "\"><span class=\"cliquable\" onclick=\"up(" + i + ")\"> (↑) </span><span class=\"cliquable\" onclick=\"down(" + i + ")\"> (↓) </span><span class=\"cliquable\" onclick=\"sup(" + i + ")\"> (✘) </span><textarea class=\"message\" cols=\"120\" rows=\"1\">" + todo + "</textarea></p>";            
                //return "<p class=\"liste " + classe + "\"><button class=\"cliquable\" onclick=\"sup(" + i + ")\"> ✘ </button>\n\
                //        <textarea class=\"message\" cols=\"150\" rows=\"3\">" + todo + "</textarea></p>";
            }

            window.onload = function () {
                horloge(document);
                setInterval(horloge, 1000, document);
                create();
            };
        </script>
        <script>
            $(function () {
                $("#iddp").datepicker();
            });
        </script>
        <script>

            var init = function () {
                $('#iddp').datepicker({autoSize: true, defaultDate: new Date()});
                var date = new Date();

                document.getElementById("iddp").value = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();

                document.getElementById("hordre").selectedIndex = date.getHours();
                document.getElementById("mordre").selectedIndex = 0;
                document.getElementById("hdebut").selectedIndex = 2;
                document.getElementById("mdebut").selectedIndex = 0;
                document.getElementById("hfin").selectedIndex = 23;
                document.getElementById("mfin").selectedIndex = 11;
                document.getElementById('newtodo').value = "";

                document.getElementById('iddate').checked = true;
                document.getElementById('idordre').checked = false;
                document.getElementById('iddebut').checked = false;
                document.getElementById('idfin').checked = false;
                document.getElementById('idcbjour').checked = false;
                $("#iddp").disabled = false;
                document.getElementById('hdebut').disabled = true;
                document.getElementById('mdebut').disabled = true;
                document.getElementById('hordre').disabled = true;
                document.getElementById('mordre').disabled = true;
                document.getElementById('hfin').disabled = true;
                document.getElementById('mfin').disabled = true;
                document.getElementById('idjour').disabled = true;
                document.getElementById('idjour').selectedIndex = 0;
            };
            var initHandlers = function () {
                init();

                document.getElementById("iddate").addEventListener("click", toggle, false);
                document.getElementById("iddebut").addEventListener("click", toggle, false);
                document.getElementById("idordre").addEventListener("click", toggle, false);
                document.getElementById("idfin").addEventListener("click", toggle, false);
                document.getElementById("idcbjour").addEventListener("click", toggle, false);

                document.getElementById("iddate").addEventListener("click", mutex, false);
                document.getElementById("idcbjour").addEventListener("click", mutex, false);

                document.getElementById("sendbutton").addEventListener("click", send, false);
            };
            var unloadHandlers = function () {
                document.getElementById("iddate").removeEventListener("click", toggle, false);
                document.getElementById("iddebut").removeEventListener("click", toggle, false);
                document.getElementById("idordre").removeEventListener("click", toggle, false);
                document.getElementById("idfin").removeEventListener("click", toggle, false);
            };
            //chargement de la page
            window.addEventListener("load", initHandlers, false);
            //déchargement de la page
            window.addEventListener("unload", unloadHandlers, false);
        </script>


        <script>
            // Connexion à socket.io
            //var socket = io.connect('http://192.168.1.56:8080');
            var socket = io.connect('http://' + hostname + ':8080');
            //var socket = io.connect('http://hostname:8080');

            document.title = "Bonjour Maman";

            socket.emit('new', '');

            // Demande de mise à jour
            socket.on('update', function (data) {
                $('#zone_msg').empty();
                data.todaylist = datify(data.todaylist);
                for (let i in data.todaylist) {
                    $('#zone_msg').append(createOneMsg(i, data.todaylist[i]));
                }
            });
            function sup(event) {
                socket.emit('sup_msg', event.target.parentElement.getAttribute("num"));
            }
        </script>
    </body>
</html>
